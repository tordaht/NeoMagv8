name: Continuous Integration

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run lint
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Generate coverage report
      run: npm run test:coverage

    - name: Check coverage threshold
      run: |
        node - <<'SCRIPT'
        const fs = require('fs');
        const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
        const pct = summary.total.lines.pct;
        console.log(`Line coverage: ${pct}%`);
        if (pct < 80) {
          console.error('Coverage below 80%');
          process.exit(1);
        }
SCRIPT

    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage

  notify:
    runs-on: ubuntu-latest
    needs: build
    if: failure()
    steps:
    - name: Send Slack notification on failure
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ needs.build.result }}
        fields: workflow,job,commit,author
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    - name: Send e-mail notification on failure
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: 'CI workflow failed'
        to: ${{ secrets.ALERT_EMAIL_TO }}
        from: ${{ secrets.ALERT_EMAIL_FROM }}
        secure: true

